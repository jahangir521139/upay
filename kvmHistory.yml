---
- name: Collect KVM VM info and generate CSV
  hosts: kvm_hosts
  gather_facts: false
  vars:
    csv_report: "Name,State,CPU,Memory(MB),Disk,IP\n"

  tasks:
    - name: Get list of VMs
      command: virsh list --all --name
      register: vm_list

    - name: Collect VM info for each VM
      shell: virsh dumpxml {{ item }}
      register: vm_xml
      loop: "{{ vm_list.stdout_lines }}"
      changed_when: false

    - name: Add data to CSV
      set_fact:
        csv_report: >-
          {{ csv_report }}
          {{ item.item }},
          {{ (item.stdout | from_xml).domain.status }},
          {{ (item.stdout | from_xml).domain.vcpu['#text'] }},
          {{ (( (item.stdout | from_xml).domain.memory['#text']) | int) / 1024 }},
          {{ ((item.stdout | from_xml).domain.devices.disk[0].target.dev) if (item.stdout | from_xml).domain.devices.disk is defined else 'N/A' }},
          N/A
          \n
      loop: "{{ vm_xml.results }}"

    - name: Save CSV to file
      copy:
        content: "{{ csv_report }}"
        dest: "/tmp/kvm_vm_report.csv"

- name: Send VM CSV report via email
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Email CSV report
      community.general.mail:
        host: 172.23.18.26
        port: 465
        username: ansible@upay.systems
        password: Upay@321
        to: m.jahangir.alam@ucb.com.bd
        subject: "KVM VM Info Report"
        body: "Attached is the full VM information report for all KVM hosts."
        attach:
          - "/tmp/kvm_vm_report.csv"
